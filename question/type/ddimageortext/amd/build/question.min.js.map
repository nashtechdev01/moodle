{"version":3,"sources":["../src/question.js"],"names":["define","$","dragDrop","keys","DragDropOntoImageQuestion","containerId","readOnly","places","M","util","js_pending","allImagesLoaded","imageLoadingTimeoutId","getRoot","addClass","thisQ","getNotYetLoadedImages","one","waitForAllImagesToBeLoaded","cvDropBackground","prototype","clearTimeout","length","setTimeout","setupQuestion","find","not","i","imgNode","imageIsLoaded","imgElement","complete","naturalHeight","resizeAllDragsAndDrops","cloneDrags","positionDragsAndDrops","js_complete","each","node","resizeAllDragsAndDropsInGroup","getClassnameNumericSuffix","group","root","dragHomes","maxWidth","maxHeight","drag","Math","max","ceil","offsetWidth","offsetHeight","left","round","top","floor","css","hasOwnProperty","place","label","text","parseInt","get_string","append","width","height","index","dragHome","cloneDragsForOneChoice","hasClass","noOfDrags","noOfDropsInGroup","getGroup","cloneDrag","clone","removeClass","offset","bgPosition","bgImage","dropNode","drop","getPlace","xy","dragNode","currentPlace","getDragHome","getChoice","inputNode","input","choice","val","getUnplacedChoice","data","fixLayoutIfBackgroundMoved","prevTop","prevLeft","handleDragStart","e","target","closest","info","prepare","start","setInputValue","x","y","dragMove","dragEnd","pageX","pageY","isPointInDrop","placed","sendDragToDrop","sendDragHome","renderCanvasDropBackground","oldDrag","getCurrentDragInPlace","animateTo","handleKeyPress","currentDrag","nextDrag","keyCode","space","arrowRight","arrowDown","getNextDrag","arrowLeft","arrowUp","getPreviousDrag","escape","preventDefault","numChoices","noOfChoicesInGroup","next","previous","currentPos","targetPos","animate","duration","done","position","document","getElementById","slice","prefix","classes","attr","classesArr","split","patt1","RegExp","test","patt2","match","exec","initDropBackground","prop","drawImage","source","strokeStyle","fromCenter","renderDropPlaces","renderDraggedPlaces","prepareUnplaceItems","dropZone","nodeInfo","drawRect","fillStyle","opacity","restoreCanvas","dragGroup","groupNumber","choices","dragPlaced","push","inArray","dragPlaces","fontSize","html","texts","replace","drawText","fontFamily","nodePos","outerWidth","outerHeight","questionManager","eventHandlersInitialised","questions","init","setupEventHandlers","on","window","handleWindowResize","fixLayoutIfThingsMoved","intCanvasesDropBackground","question","getQuestionForEvent","currentTarget"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * JavaScript to allow dragging options to slots (using mouse down or touch) or tab through slots using keyboard.\n *\n * @module     qtype_ddimageortext/question\n * @package    qtype_ddimageortext\n * @copyright  2018 The Open University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/dragdrop', 'core/key_codes', 'qtype_ddimageortext/jcanvas'],\n    function($, dragDrop, keys) {\n\n    \"use strict\";\n\n    /**\n     * Initialise one drag-drop onto image question.\n     *\n     * @param {String} containerId id of the outer div for this question.\n     * @param {boolean} readOnly whether the question is being displayed read-only.\n     * @param {Array} places Information about the drop places.\n     * @constructor\n     */\n    function DragDropOntoImageQuestion(containerId, readOnly, places) {\n        this.containerId = containerId;\n        M.util.js_pending('qtype_ddimageortext-init-' + this.containerId);\n        this.places = places;\n        this.allImagesLoaded = false;\n        this.imageLoadingTimeoutId = null;\n        if (readOnly) {\n            this.getRoot().addClass('qtype_ddimageortext-readonly');\n        }\n\n        var thisQ = this;\n        this.getNotYetLoadedImages().one('load', function() {\n            thisQ.waitForAllImagesToBeLoaded();\n        });\n        this.waitForAllImagesToBeLoaded();\n        this.cvDropBackground = $('#ddcv-dropbackground-' + containerId);\n    }\n\n    /**\n     * Waits until all images are loaded before calling setupQuestion().\n     *\n     * This function is called from the onLoad of each image, and also polls with\n     * a time-out, because image on-loads are allegedly unreliable.\n     */\n    DragDropOntoImageQuestion.prototype.waitForAllImagesToBeLoaded = function() {\n        var thisQ = this;\n\n        // This method may get called multiple times (via image on-loads or timeouts.\n        // If we are already done, don't do it again.\n        if (this.allImagesLoaded) {\n            return;\n        }\n\n        // Clear any current timeout, if set.\n        if (this.imageLoadingTimeoutId !== null) {\n            clearTimeout(this.imageLoadingTimeoutId);\n        }\n\n        // If we have not yet loaded all images, set a timeout to\n        // call ourselves again, since apparently images on-load\n        // events are flakey.\n        if (this.getNotYetLoadedImages().length > 0) {\n            this.imageLoadingTimeoutId = setTimeout(function() {\n                thisQ.waitForAllImagesToBeLoaded();\n            }, 100);\n            return;\n        }\n\n        // We now have all images. Carry on, but only after giving the layout a chance to settle down.\n        this.allImagesLoaded = true;\n        thisQ.setupQuestion();\n    };\n\n    /**\n     * Get any of the images in the drag-drop area that are not yet fully loaded.\n     *\n     * @returns {jQuery} those images.\n     */\n    DragDropOntoImageQuestion.prototype.getNotYetLoadedImages = function() {\n        var thisQ = this;\n        return this.getRoot().find('.ddarea img').not(function(i, imgNode) {\n            return thisQ.imageIsLoaded(imgNode);\n        });\n    };\n\n    /**\n     * Check if an image has loaded without errors.\n     *\n     * @param {HTMLImageElement} imgElement an image.\n     * @returns {boolean} true if this image has loaded without errors.\n     */\n    DragDropOntoImageQuestion.prototype.imageIsLoaded = function(imgElement) {\n        return imgElement.complete && imgElement.naturalHeight !== 0;\n    };\n\n    /**\n     * Set up the question, once all images have been loaded.\n     */\n    DragDropOntoImageQuestion.prototype.setupQuestion = function() {\n        this.resizeAllDragsAndDrops();\n        this.cloneDrags();\n        this.positionDragsAndDrops();\n        M.util.js_complete('qtype_ddimageortext-init-' + this.containerId);\n    };\n\n    /**\n     * In each group, resize all the items to be the same size.\n     */\n    DragDropOntoImageQuestion.prototype.resizeAllDragsAndDrops = function() {\n        var thisQ = this;\n        this.getRoot().find('.draghomes > div').each(function(i, node) {\n            thisQ.resizeAllDragsAndDropsInGroup(\n                    thisQ.getClassnameNumericSuffix($(node), 'dragitemgroup'));\n        });\n    };\n\n    /**\n     * In a given group, set all the drags and drops to be the same size.\n     *\n     * @param {int} group the group number.\n     */\n    DragDropOntoImageQuestion.prototype.resizeAllDragsAndDropsInGroup = function(group) {\n        var root = this.getRoot(),\n            dragHomes = root.find('.dragitemgroup' + group + ' .draghome'),\n            maxWidth = 0,\n            maxHeight = 0;\n\n        // Find the maximum size of any drag in this groups.\n        dragHomes.each(function(i, drag) {\n            maxWidth = Math.max(maxWidth, Math.ceil(drag.offsetWidth));\n            maxHeight = Math.max(maxHeight, Math.ceil(drag.offsetHeight));\n        });\n\n        // The size we will want to set is a bit bigger than this.\n        maxWidth += 10;\n        maxHeight += 10;\n\n        // Set each drag home to that size.\n        dragHomes.each(function(i, drag) {\n            var left = Math.round((maxWidth - drag.offsetWidth) / 2),\n                top = Math.floor((maxHeight - drag.offsetHeight) / 2);\n            // Set top and left padding so the item is centred.\n            $(drag).css({\n                'padding-left': left + 'px',\n                'padding-right': (maxWidth - drag.offsetWidth - left) + 'px',\n                'padding-top': top + 'px',\n                'padding-bottom': (maxHeight - drag.offsetHeight - top) + 'px'\n            });\n        });\n\n        // Create the drops and make them the right size.\n        for (var i in this.places) {\n            if (!this.places.hasOwnProperty((i))) {\n                continue;\n            }\n            var place = this.places[i],\n                label = place.text;\n            if (parseInt(place.group) !== group) {\n                continue;\n            }\n            if (label === '') {\n                label = M.util.get_string('blank', 'qtype_ddimageortext');\n            }\n            root.find('.dropzones').append('<div class=\"dropzone group' + place.group +\n                            ' place' + i + '\" tabindex=\"0\">' +\n                    '<span class=\"accesshide\">' + label + '</span>&nbsp;</div>');\n            root.find('.dropzone.place' + i).width(maxWidth - 2).height(maxHeight - 2);\n        }\n    };\n\n    /**\n     * Invisible 'drag homes' are output by the renderer. These have the same properties\n     * as the drag items but are invisible. We clone these invisible elements to make the\n     * actual drag items.\n     */\n    DragDropOntoImageQuestion.prototype.cloneDrags = function() {\n        var thisQ = this;\n        this.getRoot().find('.ddarea .draghome').each(function(index, dragHome) {\n            thisQ.cloneDragsForOneChoice($(dragHome));\n        });\n    };\n\n    /**\n     * Clone drag item for one choice.\n     *\n     * @param {jQuery} dragHome the drag home to clone.\n     */\n    DragDropOntoImageQuestion.prototype.cloneDragsForOneChoice = function(dragHome) {\n        if (dragHome.hasClass('infinite')) {\n            var noOfDrags = this.noOfDropsInGroup(this.getGroup(dragHome));\n            for (var i = 0; i < noOfDrags; i++) {\n                this.cloneDrag(dragHome);\n            }\n        } else {\n            this.cloneDrag(dragHome);\n        }\n    };\n\n    /**\n     * Clone drag item.\n     *\n     * @param {jQuery} dragHome\n     */\n    DragDropOntoImageQuestion.prototype.cloneDrag = function(dragHome) {\n        var drag = dragHome.clone();\n        drag.removeClass('draghome')\n            .addClass('drag unplaced moodle-has-zindex')\n            .offset(dragHome.offset());\n        this.getRoot().find('.dragitems').append(drag);\n    };\n\n    /**\n     * Update the position of drags.\n     */\n    DragDropOntoImageQuestion.prototype.positionDragsAndDrops = function() {\n        var thisQ = this,\n            root = this.getRoot(),\n            bgPosition = this.bgImage().offset();\n\n        // Move the drops into position.\n        root.find('.ddarea .dropzone').each(function(i, dropNode) {\n            var drop = $(dropNode),\n                place = thisQ.places[thisQ.getPlace(drop)];\n            // The xy values come from PHP as strings, so we need parseInt to stop JS doing string concatenation.\n            drop.offset({\n                left: bgPosition.left + parseInt(place.xy[0]),\n                top: bgPosition.top + parseInt(place.xy[1])});\n        });\n\n        // First move all items back home.\n        root.find('.ddarea .drag').each(function(i, dragNode) {\n            var drag = $(dragNode),\n                currentPlace = thisQ.getClassnameNumericSuffix(drag, 'inplace');\n            drag.addClass('unplaced')\n                .removeClass('placed')\n                .offset(thisQ.getDragHome(thisQ.getGroup(drag), thisQ.getChoice(drag)).offset());\n            if (currentPlace !== null) {\n                drag.removeClass('inplace' + currentPlace);\n            }\n        });\n\n        // Then place the ones that should be placed.\n        root.find('input.placeinput').each(function(i, inputNode) {\n            var input = $(inputNode),\n                choice = input.val();\n            if (choice === '0') {\n                // No item in this place.\n                return;\n            }\n\n            var place = thisQ.getPlace(input);\n            thisQ.getUnplacedChoice(thisQ.getGroup(input), choice)\n                .removeClass('unplaced')\n                .addClass('placed inplace' + place)\n                .offset(root.find('.dropzone.place' + place).offset());\n        });\n\n        this.bgImage().data('prev-top', bgPosition.top).data('prev-left', bgPosition.left);\n    };\n\n    /**\n     * Check to see if the background image has moved. If so, refresh the layout.\n     */\n    DragDropOntoImageQuestion.prototype.fixLayoutIfBackgroundMoved = function() {\n        var bgImage = this.bgImage(),\n            bgPosition = bgImage.offset(),\n            prevTop = bgImage.data('prev-top'),\n            prevLeft = bgImage.data('prev-left');\n        if (prevLeft === undefined || prevTop === undefined) {\n            // Question is not set up yet. Nothing to do.\n            return;\n        }\n        if (prevTop === bgPosition.top && prevLeft === bgPosition.left) {\n            // Things have not moved.\n            return;\n        }\n        // We need to reposition things.\n        this.positionDragsAndDrops();\n    };\n\n    /**\n     * Handles the start of dragging an item.\n     *\n     * @param {Event} e the touch start or mouse down event.\n     */\n    DragDropOntoImageQuestion.prototype.handleDragStart = function(e) {\n        var thisQ = this,\n            drag = $(e.target).closest('.drag');\n\n        var info = dragDrop.prepare(e);\n        if (!info.start) {\n            return;\n        }\n\n        var currentPlace = this.getClassnameNumericSuffix(drag, 'inplace');\n        if (currentPlace !== null) {\n            this.setInputValue(currentPlace, 0);\n            drag.removeClass('inplace' + currentPlace);\n        }\n\n        drag.addClass('beingdragged');\n        dragDrop.start(e, drag, function(x, y, drag) {\n            thisQ.dragMove(x, y, drag);\n        }, function(x, y, drag) {\n            thisQ.dragEnd(x, y, drag);\n        });\n    };\n\n    /**\n     * Called whenever the currently dragged items moves.\n     *\n     * @param {Number} pageX the x position.\n     * @param {Number} pageY the y position.\n     * @param {jQuery} drag the item being moved.\n     */\n    DragDropOntoImageQuestion.prototype.dragMove = function(pageX, pageY, drag) {\n        var thisQ = this;\n        this.getRoot().find('.dropzone.group' + this.getGroup(drag)).each(function(i, dropNode) {\n            var drop = $(dropNode);\n            if (thisQ.isPointInDrop(pageX, pageY, drop)) {\n                drop.addClass('valid-drag-over-drop');\n            } else {\n                drop.removeClass('valid-drag-over-drop');\n            }\n        });\n    };\n\n    /**\n     * Called when user drops a drag item.\n     *\n     * @param {Number} pageX the x position.\n     * @param {Number} pageY the y position.\n     * @param {jQuery} drag the item being moved.\n     */\n    DragDropOntoImageQuestion.prototype.dragEnd = function(pageX, pageY, drag) {\n        var thisQ = this,\n            root = this.getRoot(),\n            placed = false;\n        root.find('.dropzone.group' + this.getGroup(drag)).each(function(i, dropNode) {\n            var drop = $(dropNode);\n            if (!thisQ.isPointInDrop(pageX, pageY, drop)) {\n                // Not this drop.\n                return true;\n            }\n\n            // Now put this drag into the drop.\n            drop.removeClass('valid-drag-over-drop');\n            thisQ.sendDragToDrop(drag, drop);\n            placed = true;\n            return false; // Stop the each() here.\n        });\n\n        if (!placed) {\n            this.sendDragHome(drag);\n        }\n        // Update canvas if anything has changed.\n        setTimeout(function() {\n            thisQ.renderCanvasDropBackground();\n        }, 200);\n    };\n\n    /**\n     * Animate a drag item into a given place (or back home).\n     *\n     * @param {jQuery|null} drag the item to place. If null, clear the place.\n     * @param {jQuery} drop the place to put it.\n     */\n    DragDropOntoImageQuestion.prototype.sendDragToDrop = function(drag, drop) {\n        // Is there already a drag in this drop? if so, evict it.\n        var oldDrag = this.getCurrentDragInPlace(this.getPlace(drop));\n        if (oldDrag.length !== 0) {\n            this.sendDragHome(oldDrag);\n        }\n\n        if (drag.length === 0) {\n            this.setInputValue(this.getPlace(drop), 0);\n        } else {\n            this.setInputValue(this.getPlace(drop), this.getChoice(drag));\n            drag.removeClass('unplaced')\n                .addClass('placed inplace' + this.getPlace(drop));\n            this.animateTo(drag, drop);\n        }\n    };\n\n    /**\n     * Animate a drag back to its home.\n     *\n     * @param {jQuery} drag the item being moved.\n     */\n    DragDropOntoImageQuestion.prototype.sendDragHome = function(drag) {\n        drag.removeClass('placed').addClass('unplaced');\n        var currentPlace = this.getClassnameNumericSuffix(drag, 'inplace');\n        if (currentPlace !== null) {\n            drag.removeClass('inplace' + currentPlace);\n        }\n\n        this.animateTo(drag, this.getDragHome(this.getGroup(drag), this.getChoice(drag)));\n    };\n\n    /**\n     * Handles keyboard events on drops.\n     *\n     * Drops are focusable. Once focused, right/down/space switches to the next choice, and\n     * left/up switches to the previous. Escape clear.\n     *\n     * @param {KeyboardEvent} e\n     */\n    DragDropOntoImageQuestion.prototype.handleKeyPress = function(e) {\n        var drop = $(e.target).closest('.dropzone'),\n            currentDrag = this.getCurrentDragInPlace(this.getPlace(drop)),\n            nextDrag = $();\n\n        switch (e.keyCode) {\n            case keys.space:\n            case keys.arrowRight:\n            case keys.arrowDown:\n                nextDrag = this.getNextDrag(this.getGroup(drop), currentDrag);\n                break;\n\n            case keys.arrowLeft:\n            case keys.arrowUp:\n                nextDrag = this.getPreviousDrag(this.getGroup(drop), currentDrag);\n                break;\n\n            case keys.escape:\n                break;\n\n            default:\n                return; // To avoid the preventDefault below.\n        }\n\n        e.preventDefault();\n        this.sendDragToDrop(nextDrag, drop);\n    };\n\n    /**\n     * Choose the next drag in a group.\n     *\n     * @param {int} group which group.\n     * @param {jQuery} drag current choice (empty jQuery if there isn't one).\n     * @return {jQuery} the next drag in that group, or null if there wasn't one.\n     */\n    DragDropOntoImageQuestion.prototype.getNextDrag = function(group, drag) {\n        var choice,\n            numChoices = this.noOfChoicesInGroup(group);\n\n        if (drag.length === 0) {\n            choice = 1; // Was empty, so we want to select the first choice.\n        } else {\n            choice = this.getChoice(drag) + 1;\n        }\n\n        var next = this.getUnplacedChoice(group, choice);\n        while (next.length === 0 && choice < numChoices) {\n            choice++;\n            next = this.getUnplacedChoice(group, choice);\n        }\n\n        return next;\n    };\n\n    /**\n     * Choose the previous drag in a group.\n     *\n     * @param {int} group which group.\n     * @param {jQuery} drag current choice (empty jQuery if there isn't one).\n     * @return {jQuery} the next drag in that group, or null if there wasn't one.\n     */\n    DragDropOntoImageQuestion.prototype.getPreviousDrag = function(group, drag) {\n        var choice;\n\n        if (drag.length === 0) {\n            choice = this.noOfChoicesInGroup(group);\n        } else {\n            choice = this.getChoice(drag) - 1;\n        }\n\n        var previous = this.getUnplacedChoice(group, choice);\n        while (previous.length === 0 && choice > 1) {\n            choice--;\n            previous = this.getUnplacedChoice(group, choice);\n        }\n\n        // Does this choice exist?\n        return previous;\n    };\n\n    /**\n     * Animate an object to the given destination.\n     *\n     * @param {jQuery} drag the element to be animated.\n     * @param {jQuery} target element marking the place to move it to.\n     */\n    DragDropOntoImageQuestion.prototype.animateTo = function(drag, target) {\n        var currentPos = drag.offset(),\n            targetPos = target.offset();\n        drag.addClass('beingdragged');\n\n        // Animate works in terms of CSS position, whereas locating an object\n        // on the page works best with jQuery offset() function. So, to get\n        // the right target position, we work out the required change in\n        // offset() and then add that to the current CSS position.\n        drag.animate(\n            {\n                left: parseInt(drag.css('left')) + targetPos.left - currentPos.left,\n                top: parseInt(drag.css('top')) + targetPos.top - currentPos.top\n            },\n            {\n                duration: 'fast',\n                done: function() {\n                    drag.removeClass('beingdragged');\n                    // It seems that the animation sometimes leaves the drag\n                    // one pixel out of position. Put it in exactly the right place.\n                    drag.offset(targetPos);\n                }\n            }\n        );\n    };\n\n    /**\n     * Detect if a point is inside a given DOM node.\n     *\n     * @param {Number} pageX the x position.\n     * @param {Number} pageY the y position.\n     * @param {jQuery} drop the node to check (typically a drop).\n     * @return {boolean} whether the point is inside the node.\n     */\n    DragDropOntoImageQuestion.prototype.isPointInDrop = function(pageX, pageY, drop) {\n        var position = drop.offset();\n        return pageX >= position.left && pageX < position.left + drop.width()\n            && pageY >= position.top && pageY < position.top + drop.height();\n    };\n\n    /**\n     * Set the value of the hidden input for a place, to record what is currently there.\n     *\n     * @param {int} place which place to set the input value for.\n     * @param {int} choice the value to set.\n     */\n    DragDropOntoImageQuestion.prototype.setInputValue = function(place, choice) {\n        this.getRoot().find('input.placeinput.place' + place).val(choice);\n    };\n\n    /**\n     * Get the outer div for this question.\n     *\n     * @returns {jQuery} containing that div.\n     */\n    DragDropOntoImageQuestion.prototype.getRoot = function() {\n        return $(document.getElementById(this.containerId));\n    };\n\n    /**\n     * Get the img that is the background image.\n     * @returns {jQuery} containing that img.\n     */\n    DragDropOntoImageQuestion.prototype.bgImage = function() {\n        return this.getRoot().find('img.dropbackground');\n    };\n\n    /**\n     * Get drag home for a given choice.\n     *\n     * @param {int} group the group.\n     * @param {int} choice the choice number.\n     * @returns {jQuery} containing that div.\n     */\n    DragDropOntoImageQuestion.prototype.getDragHome = function(group, choice) {\n        return this.getRoot().find('.ddarea .draghome.group' + group + '.choice' + choice);\n    };\n\n    /**\n     * Get an unplaced choice for a particular group.\n     *\n     * @param {int} group the group.\n     * @param {int} choice the choice number.\n     * @returns {jQuery} jQuery wrapping the unplaced choice. If there isn't one, the jQuery will be empty.\n     */\n    DragDropOntoImageQuestion.prototype.getUnplacedChoice = function(group, choice) {\n        return this.getRoot().find('.ddarea .drag.group' + group + '.choice' + choice + '.unplaced').slice(0, 1);\n    };\n\n    /**\n     * Get the drag that is currently in a given place.\n     *\n     * @param {int} place the place number.\n     * @return {jQuery} the current drag (or an empty jQuery if none).\n     */\n    DragDropOntoImageQuestion.prototype.getCurrentDragInPlace = function(place) {\n        return this.getRoot().find('.ddarea .drag.inplace' + place);\n    };\n\n    /**\n     * Return the number of blanks in a given group.\n     *\n     * @param {int} group the group number.\n     * @returns {int} the number of drops.\n     */\n    DragDropOntoImageQuestion.prototype.noOfDropsInGroup = function(group) {\n        return this.getRoot().find('.dropzone.group' + group).length;\n    };\n\n    /**\n     * Return the number of choices in a given group.\n     *\n     * @param {int} group the group number.\n     * @returns {int} the number of choices.\n     */\n    DragDropOntoImageQuestion.prototype.noOfChoicesInGroup = function(group) {\n        return this.getRoot().find('.dragitemgroup' + group + ' .draghome').length;\n    };\n\n    /**\n     * Return the number at the end of the CSS class name with the given prefix.\n     *\n     * @param {jQuery} node\n     * @param {String} prefix name prefix\n     * @returns {Number|null} the suffix if found, else null.\n     */\n    DragDropOntoImageQuestion.prototype.getClassnameNumericSuffix = function(node, prefix) {\n        var classes = node.attr('class');\n        if (classes !== '') {\n            var classesArr = classes.split(' ');\n            for (var index = 0; index < classesArr.length; index++) {\n                var patt1 = new RegExp('^' + prefix + '([0-9])+$');\n                if (patt1.test(classesArr[index])) {\n                    var patt2 = new RegExp('([0-9])+$');\n                    var match = patt2.exec(classesArr[index]);\n                    return Number(match[0]);\n                }\n            }\n        }\n        return null;\n    };\n\n    /**\n     * Get the choice number of a drag.\n     *\n     * @param {jQuery} drag the drag.\n     * @returns {Number} the choice number.\n     */\n    DragDropOntoImageQuestion.prototype.getChoice = function(drag) {\n        return this.getClassnameNumericSuffix(drag, 'choice');\n    };\n\n    /**\n     * Given a DOM node that is significant to this question\n     * (drag, drop, ...) get the group it belongs to.\n     *\n     * @param {jQuery} node a DOM node.\n     * @returns {Number} the group it belongs to.\n     */\n    DragDropOntoImageQuestion.prototype.getGroup = function(node) {\n        return this.getClassnameNumericSuffix(node, 'group');\n    };\n\n    /**\n     * Get the place number of a drop, or its corresponding hidden input.\n     *\n     * @param {jQuery} node the DOM node.\n     * @returns {Number} the place number.\n     */\n    DragDropOntoImageQuestion.prototype.getPlace = function(node) {\n        return this.getClassnameNumericSuffix(node, 'place');\n    };\n\n    /**\n     * Init canvas and background.\n     */\n    DragDropOntoImageQuestion.prototype.initDropBackground = function() {\n        var bgImage = this.bgImage();\n        this.cvDropBackground.prop({\n            width: parseInt(bgImage.width()),\n            height: parseInt(bgImage.height()),\n        }).drawImage({\n            source: bgImage.attr('src'),\n            strokeStyle: bgImage.css('border'),\n            x: 0, y: 0,\n            width: parseInt(bgImage.width()),\n            height: parseInt(bgImage.height()),\n            fromCenter: false\n        });\n    };\n\n    /**\n     * To avoid dropbackground and dragdrop nodes display incorrectly when printing,\n     * they are render to canvas.\n     */\n    DragDropOntoImageQuestion.prototype.renderCanvasDropBackground = function() {\n        this.initDropBackground();\n        this.renderDropPlaces();\n        this.renderDraggedPlaces();\n        this.prepareUnplaceItems();\n    };\n\n    /**\n     * Render drop places in background image.\n     */\n    DragDropOntoImageQuestion.prototype.renderDropPlaces = function() {\n        var thisQ = this;\n        this.getRoot().find('.dropzones div').each(function(index, dropZone) {\n            var drop = $(dropZone);\n            // Calculate position.\n            var nodeInfo = thisQ.nodeInfo(drop);\n            thisQ.cvDropBackground.drawRect({\n                fillStyle: drop.css('background-color'),\n                strokeStyle: drop.css('border-color'),\n                opacity: drop.css('opacity'),\n                x: nodeInfo.x,\n                y: nodeInfo.y,\n                width: nodeInfo.width,\n                height: nodeInfo.height,\n                fromCenter: false\n            }).restoreCanvas();\n        });\n    };\n\n    /**\n     * Prepare unplace item before print.\n     */\n    DragDropOntoImageQuestion.prototype.prepareUnplaceItems = function() {\n        var thisQ = this;\n        this.getRoot().find('.ddarea .draghome').removeClass('printhide');\n        this.getRoot().find('.draghomes > div').each(function(index, dragGroup) {\n            // Separate group choices.\n            var groupNumber = thisQ.getClassnameNumericSuffix($(dragGroup), 'dragitemgroup');\n            if (groupNumber !== null) {\n                var choices = [];\n                thisQ.getRoot().find('.dragitems .drag.placed.group' + groupNumber).each(function(index, dragPlaced) {\n                    var drag = $(dragPlaced);\n                    var choice = parseInt(thisQ.getChoice(drag));\n                    choices.push(choice);\n                });\n                thisQ.getRoot().find('.draghomes .draghome.group' + groupNumber).each(function(index, dragHome) {\n                    var drag = $(dragHome);\n                    var choice = parseInt(thisQ.getChoice(drag));\n                    if ($.inArray(choice, choices) >= 0) {\n                        drag.addClass('printhide').addClass('group' + groupNumber);\n                    }\n                });\n            }\n        });\n    };\n\n    /**\n     * Render items that put on the background\n     */\n    DragDropOntoImageQuestion.prototype.renderDraggedPlaces = function() {\n        var thisQ = this;\n        var dragPlaces = this.getRoot().find('.dragitems .drag.placed');\n        var fontSize = parseInt(dragPlaces.css('font-size'));\n\n        dragPlaces.each(function(index, dragPlaced) {\n            var drag = $(dragPlaced);\n            // Calculate position.\n            var nodeInfo = thisQ.nodeInfo(drag);\n            thisQ.cvDropBackground.drawRect({\n                fillStyle: drag.css('background-color'),\n                strokeStyle: drag.css('border-color'),\n                x: nodeInfo.x,\n                y: nodeInfo.y,\n                width: nodeInfo.width,\n                height: nodeInfo.height,\n                fromCenter: false\n            }).restoreCanvas();\n            // Drop text.\n            var text = drag.html();\n            if (text.length > 0) {\n                var texts = text.replace(/<br[^>]*>/gi, '<br>').split('<br>');\n                var y = nodeInfo.y + fontSize;\n                for (var i = 0; i < texts.length; i++) {\n                    thisQ.cvDropBackground.drawText({\n                        fillStyle: drag.css('color'),\n                        x: nodeInfo.x + (nodeInfo.width / 2),\n                        y: y,\n                        fontSize: fontSize,\n                        fontFamily: drag.css('font-family'),\n                        text: texts[i],\n                        fromCenter: true\n                    });\n                    y += fontSize;\n                }\n            } else {\n                // Drop image.\n                thisQ.cvDropBackground.drawImage({\n                    source: drag.attr('src'),\n                    x: nodeInfo.x + parseInt(fontSize / 2),\n                    y: nodeInfo.y + parseInt(fontSize / 2),\n                    width: parseInt(drag.width()),\n                    height: parseInt(drag.height()),\n                    fromCenter: false\n                });\n            }\n        });\n    };\n\n    /**\n     * Calculate width, height, x, y for dragdrop node\n     *\n     * @param {jQuery} node\n     * @returns {{x: number, width: number, y: number, height: number}}\n     */\n    DragDropOntoImageQuestion.prototype.nodeInfo = function(node) {\n        var bgImage = this.bgImage(),\n            bgPosition = bgImage.offset();\n        var nodePos = node.offset();\n        return {\n            x: parseInt(nodePos.left) - parseInt(bgPosition.left),\n            y: parseInt(nodePos.top) - parseInt(bgPosition.top),\n            width: parseInt(node.outerWidth()),\n            height: parseInt(node.outerHeight())\n        };\n    };\n\n    /**\n     * Singleton object that handles all the DragDropOntoImageQuestions\n     * on the page, and deals with event dispatching.\n     * @type {Object}\n     */\n    var questionManager = {\n\n        /**\n         * {boolean} ensures that the event handlers are only initialised once per page.\n         */\n        eventHandlersInitialised: false,\n\n        /**\n         * {Object} all the questions on this page, indexed by containerId (id on the .que div).\n         */\n        questions: {}, // An object containing all the information about each question on the page.\n\n        /**\n         * Initialise one question.\n         *\n         * @param {String} containerId the id of the div.que that contains this question.\n         * @param {boolean} readOnly whether the question is read-only.\n         * @param {Array} places data.\n         */\n        init: function(containerId, readOnly, places) {\n            questionManager.questions[containerId] =\n                new DragDropOntoImageQuestion(containerId, readOnly, places);\n            if (!questionManager.eventHandlersInitialised) {\n                questionManager.setupEventHandlers();\n                questionManager.eventHandlersInitialised = true;\n            }\n        },\n\n        /**\n         * Set up the event handlers that make this question type work. (Done once per page.)\n         */\n        setupEventHandlers: function() {\n            $('body')\n                .on('mousedown touchstart',\n                    '.que.ddimageortext:not(.qtype_ddimageortext-readonly) .dragitems .drag',\n                    questionManager.handleDragStart)\n                .on('keydown',\n                    '.que.ddimageortext:not(.qtype_ddimageortext-readonly) .dropzones .dropzone',\n                    questionManager.handleKeyPress);\n            $(window).on('resize', questionManager.handleWindowResize);\n            setTimeout(questionManager.fixLayoutIfThingsMoved, 100);\n            setTimeout(questionManager.intCanvasesDropBackground, 100);\n        },\n\n        /**\n         * Initialise canvases drop background when page loaded.\n         */\n        intCanvasesDropBackground: function() {\n            for (var containerId in questionManager.questions) {\n                if (questionManager.questions.hasOwnProperty(containerId)) {\n                    questionManager.questions[containerId].renderCanvasDropBackground();\n                }\n            }\n        },\n\n        /**\n         * Handle mouse down / touch start events on drags.\n         * @param {Event} e the DOM event.\n         */\n        handleDragStart: function(e) {\n            e.preventDefault();\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleDragStart(e);\n            }\n        },\n\n        /**\n         * Handle key down / press events on drags.\n         * @param {KeyboardEvent} e\n         */\n        handleKeyPress: function(e) {\n            var question = questionManager.getQuestionForEvent(e);\n            if (question) {\n                question.handleKeyPress(e);\n            }\n        },\n\n        /**\n         * Handle when the window is resized.\n         */\n        handleWindowResize: function() {\n            for (var containerId in questionManager.questions) {\n                if (questionManager.questions.hasOwnProperty(containerId)) {\n                    questionManager.questions[containerId].positionDragsAndDrops();\n                }\n            }\n        },\n\n        /**\n         * Sometimes, despite our best efforts, things change in a way that cannot\n         * be specifically caught (e.g. dock expanding or collapsing in Boost).\n         * Therefore, we need to periodically check everything is in the right position.\n         */\n        fixLayoutIfThingsMoved: function() {\n            for (var containerId in questionManager.questions) {\n                if (questionManager.questions.hasOwnProperty(containerId)) {\n                    questionManager.questions[containerId].fixLayoutIfBackgroundMoved();\n                }\n            }\n\n            // We use setTimeout after finishing work, rather than setInterval,\n            // in case positioning things is slow. We want 100 ms gap\n            // between executions, not what setInterval does.\n            setTimeout(questionManager.fixLayoutIfThingsMoved, 100);\n        },\n\n        /**\n         * Given an event, work out which question it effects.\n         * @param {Event} e the event.\n         * @returns {DragDropOntoImageQuestion|undefined} The question, or undefined.\n         */\n        getQuestionForEvent: function(e) {\n            var containerId = $(e.currentTarget).closest('.que.ddimageortext').attr('id');\n            return questionManager.questions[containerId];\n        }\n    };\n\n    /**\n     * @alias module:qtype_ddimageortext/question\n     */\n    return {\n        /**\n         * Initialise one drag-drop onto image question.\n         *\n         * @param {String} containerId id of the outer div for this question.\n         * @param {boolean} readOnly whether the question is being displayed read-only.\n         * @param {Array} Information about the drop places.\n         */\n        init: questionManager.init\n    };\n});\n"],"file":"question.min.js"}